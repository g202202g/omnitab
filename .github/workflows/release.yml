name: 打包与发布

on:
  push:
    branches:
      - main
      - master
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: true

jobs:
  zip-and-release:
    runs-on: ubuntu-latest
    if: github.actor != 'github-actions[bot]'
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 计算版本号
        id: version
        shell: bash
        run: |
          set -euo pipefail

          if [[ "${GITHUB_REF_TYPE}" == "tag" ]]; then
            VERSION="${GITHUB_REF_NAME#v}"
            echo "skip_release=false" >> "$GITHUB_OUTPUT"
          else
            git fetch --tags --force

            LATEST_TAG="$(
              git tag --list 'v*' --sort=-v:refname \
                | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' \
                | head -n 1 \
                || true
            )"

            if [[ -z "${LATEST_TAG}" ]]; then
              BASE="0.0.0"
              RANGE="HEAD"
              PREVIOUS_TAG=""
            else
              BASE="${LATEST_TAG#v}"
              RANGE="${LATEST_TAG}..HEAD"
              PREVIOUS_TAG="${LATEST_TAG}"
            fi

            IFS='.' read -r MAJOR MINOR PATCH <<< "${BASE}"

            COMMITS="$(
              git log --format='%s%n%b' "${RANGE}" 2>/dev/null || true
            )"

            # 版本递增规则（自动判断最高等级）：
            # - 出现 BREAKING CHANGE / type!:/type(scope)!: -> major
            # - 出现 feat: / feat(scope): -> minor
            # - 出现 fix/perf/refactor -> patch
            # - 其他（如 docs/ci/chore）-> 不发版
            BUMP="none"
            if echo "${COMMITS}" | grep -qiE 'BREAKING CHANGE|BREAKING-CHANGE'; then
              BUMP="major"
            elif echo "${COMMITS}" | grep -qiE '^[a-zA-Z]+(\\([^\\n\\r]+\\))?!:'; then
              BUMP="major"
            elif echo "${COMMITS}" | grep -qiE '^feat(\\([^\\n\\r]+\\))?:'; then
              BUMP="minor"
            elif echo "${COMMITS}" | grep -qiE '^(fix|perf|refactor)(\\([^\\n\\r]+\\))?:'; then
              BUMP="patch"
            fi

            case "${BUMP}" in
              major)
                MAJOR="$((MAJOR + 1))"
                MINOR="0"
                PATCH="0"
                ;;
              minor)
                MINOR="$((MINOR + 1))"
                PATCH="0"
                ;;
              patch)
                PATCH="$((PATCH + 1))"
                ;;
              none)
                ;;
            esac

            VERSION="${MAJOR}.${MINOR}.${PATCH}"
            echo "最新版本：${LATEST_TAG:-（无）}"
            echo "递增方式：${BUMP}"
            echo "本次版本：v${VERSION}"

            echo "previous_tag=${PREVIOUS_TAG}" >> "$GITHUB_OUTPUT"

            if [[ "${BUMP}" == "none" ]]; then
              echo "skip_release=true" >> "$GITHUB_OUTPUT"
            else
              echo "skip_release=false" >> "$GITHUB_OUTPUT"
            fi
          fi

          if [[ ! "${VERSION}" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "版本号格式不正确：${VERSION}"
            exit 1
          fi

          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "本次打包版本：${VERSION}"

      - name: 安装 pnpm
        if: steps.version.outputs.skip_release != 'true'
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: 安装 Node.js
        if: steps.version.outputs.skip_release != 'true'
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: 安装依赖
        if: steps.version.outputs.skip_release != 'true'
        run: pnpm install --frozen-lockfile

      - name: 写入版本号
        if: steps.version.outputs.skip_release != 'true'
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ steps.version.outputs.version }}"
          pnpm pkg set version="${VERSION}"

      - name: 类型检查
        if: steps.version.outputs.skip_release != 'true'
        run: pnpm compile

      - name: 构建并打包 zip
        if: steps.version.outputs.skip_release != 'true'
        run: pnpm zip

      - name: 整理产物
        if: steps.version.outputs.skip_release != 'true'
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist

          ZIP_PATH="$(ls -1 .output/*-chrome.zip 2>/dev/null | head -n 1 || true)"
          if [[ -z "${ZIP_PATH}" ]]; then
            echo "未找到 zip 产物（期望路径：.output/*-chrome.zip）"
            exit 1
          fi

          VERSION="${{ steps.version.outputs.version }}"
          OUT_NAME="omnitab-v${VERSION}-chrome.zip"

          cp "${ZIP_PATH}" "dist/${OUT_NAME}"
          echo "已生成：dist/${OUT_NAME}"

      - name: 上传产物（Actions）
        if: steps.version.outputs.skip_release != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: omnitab-zip
          path: dist/*.zip
          if-no-files-found: error

      - name: 生成发布说明
        if: steps.version.outputs.skip_release != 'true'
        shell: bash
        run: |
          set -euo pipefail

          VERSION="${{ steps.version.outputs.version }}"
          OUT="dist/release-notes.md"

          mkdir -p dist
          : > "${OUT}"

          DATE="$(date -u +%F)"

          if [[ "${GITHUB_REF_TYPE}" == "tag" ]]; then
            CUR="${GITHUB_REF_NAME}"
            PREV="$(
              git tag --list 'v*' --sort=-v:refname \
                | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' \
                | grep -v "^${CUR}$" \
                | head -n 1 \
                || true
            )"
            RANGE="${GITHUB_SHA}"
            if [[ -n "${PREV}" ]]; then
              RANGE="${PREV}..${GITHUB_SHA}"
            fi
          else
            PREV="${{ steps.version.outputs.previous_tag }}"
            RANGE="HEAD"
            if [[ -n "${PREV}" ]]; then
              RANGE="${PREV}..HEAD"
            fi
          fi

          # 生成“用户可读”的更新内容：
          # - 优先使用提交正文里以“- ”开头的要点（比如首版的描述）
          # - 过滤掉 ci/chore 这类内部提交，避免 Release 出现实现细节
          # - 没有要点时再回退到提交标题（会去掉 feat:/fix: 等前缀）
          CONTENT="$(
            git log --no-merges --format='%H%x1f%s%x1f%b%x1e' "${RANGE}" \
              | awk -v RS='\x1e' -v FS='\x1f' '
                function strip_prefix(s) {
                  sub(/^[A-Za-z]+(\([^)]+\))?!?:[[:space:]]*/, "", s)
                  return s
                }
                function is_internal(subject) {
                  return subject ~ /^(ci|chore|docs|doc)(\([^)]+\))?!?:/
                }
                {
                  subject = $2
                  body = $3
                  gsub(/\r/, "", body)
                  gsub(/\\n/, "\n", body)

                  if (subject == "") next
                  if (is_internal(subject)) next

                  n = split(body, lines, "\n")
                  has_points = 0
                  for (i = 1; i <= n; i++) {
                    line = lines[i]
                    if (line ~ /^- /) {
                      point = substr(line, 3)
                      if (point != "") {
                        print "- " point
                        has_points = 1
                      }
                    }
                  }

                  if (!has_points) {
                    title = strip_prefix(subject)
                    if (title == "") title = subject
                    print "- " title
                  }
                }
              ' \
              | awk 'NF' \
              || true
          )"

          if [[ -z "${CONTENT//[[:space:]]/}" ]]; then
            CONTENT="- 这次主要做了整理和改进"
          fi

          {
            echo "## v${VERSION} - ${DATE}"
            echo
            printf "%s\n" "${CONTENT}"
            echo
          } > "${OUT}"

          echo "已生成发布说明：${OUT}"

      - name: 写入更新记录（不新增提交，仅分支）
        if: github.ref_type == 'branch' && steps.version.outputs.skip_release != 'true'
        shell: bash
        run: |
          set -euo pipefail

          NOTES="dist/release-notes.md"
          if [[ ! -s "${NOTES}" ]]; then
            echo "未找到发布说明：${NOTES}"
            exit 1
          fi

          if [[ ! -f CHANGELOG.md ]]; then
            {
              echo "# 更新记录"
              echo
              echo "这里会记录每次发布带来的主要变化，方便你回顾“这次更新了什么”。"
              echo
            } > CHANGELOG.md
          fi

          VERSION="${{ steps.version.outputs.version }}"
          if grep -qE "^## v${VERSION} " CHANGELOG.md; then
            echo "更新记录已存在：v${VERSION}（跳过写入）"
            exit 0
          fi

          TMP="$(mktemp)"
          cat "${NOTES}" > "${TMP}"

          # 把本次更新插到最前面的“版本列表”之前（保留标题与简介）
          awk -v new_block="$(cat "${TMP}")" '
            BEGIN { inserted = 0 }
            /^## v[0-9]+\./ && inserted == 0 {
              print ""
              print new_block
              inserted = 1
            }
            { print }
            END {
              if (inserted == 0) {
                print ""
                print new_block
              }
            }
          ' CHANGELOG.md > CHANGELOG.md.next
          mv CHANGELOG.md.next CHANGELOG.md

          rm -f "${TMP}"

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add CHANGELOG.md package.json
          git commit --amend --no-edit
          git push --force-with-lease origin "HEAD:${GITHUB_REF_NAME}"

      - name: 创建版本标签（仅分支）
        if: github.ref_type == 'branch' && steps.version.outputs.skip_release != 'true'
        shell: bash
        run: |
          set -euo pipefail
          TAG="v${{ steps.version.outputs.version }}"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          if git rev-parse -q --verify "refs/tags/${TAG}" >/dev/null; then
            echo "版本标签已存在：${TAG}（跳过）"
            exit 0
          fi

          git tag -a "${TAG}" -m "${TAG}"
          git push origin "${TAG}"

      - name: 创建 Release
        if: (github.ref_type == 'tag' || github.ref_type == 'branch') && steps.version.outputs.skip_release != 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          body_path: dist/release-notes.md
          files: dist/*.zip
